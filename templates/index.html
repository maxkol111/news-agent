{% extends "base.html" %}

{% block title %}ü§ñ –ì–ª–∞–≤–Ω–∞—è - –ù–æ–≤–æ—Å—Ç–Ω–æ–π –ò–ò-–∞–≥–µ–Ω—Ç{% endblock %}

{% block content %}
<div class="container mt-4">
    <!-- === –°–¢–ê–¢–£–° –°–ò–°–¢–ï–ú–´ === -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <i class="bi bi-speedometer2"></i> –°—Ç–∞—Ç—É—Å —Å–∏—Å—Ç–µ–º—ã
                    <span id="statusIndicator" class="float-end small">
                        <i class="bi bi-circle-fill text-success"></i>
                        <span class="ms-1">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                    </span>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <!-- –ù–æ–≤–æ—Å—Ç–µ–π –≤ –±–∞–∑–µ -->
                        <div class="col-6 col-md-3 mb-3">
                            <div class="stat-card">
                                <h2 class="text-primary" id="totalNews">
                                    {% if stats and stats.statistics and stats.statistics.total_news is defined %}
                                        {{ stats.statistics.total_news }}
                                    {% else %}
                                        0
                                    {% endif %}
                                </h2>
                                <small class="text-muted">–ù–æ–≤–æ—Å—Ç–µ–π –≤ –±–∞–∑–µ</small>
                            </div>
                        </div>
                        
                        <!-- –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ -->
                        <div class="col-6 col-md-3 mb-3">
                            <div class="stat-card">
                                <h2 class="text-success" id="analyzedNews">
                                    {% if stats and stats.statistics and stats.statistics.analyzed_news is defined %}
                                        {{ stats.statistics.analyzed_news }}
                                    {% else %}
                                        0
                                    {% endif %}
                                </h2>
                                <small class="text-muted">–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ</small>
                            </div>
                        </div>
                        
                        <!-- –ê–Ω–∞–ª–∏–∑–æ–≤ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ -->
                        <div class="col-6 col-md-3 mb-3">
                            <div class="stat-card">
                                <h2 class="text-warning" id="totalAnalyses">
                                    {% if stats and stats.statistics and stats.statistics.total_analyses is defined %}
                                        {{ stats.statistics.total_analyses }}
                                    {% else %}
                                        0
                                    {% endif %}
                                </h2>
                                <small class="text-muted">–ê–Ω–∞–ª–∏–∑–æ–≤ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ</small>
                            </div>
                        </div>
                        
                        <!-- –†–∞–∑–º–µ—Ä –±–∞–∑—ã -->
                        <div class="col-6 col-md-3 mb-3">
                            <div class="stat-card">
                                <h2 class="text-info" id="dbSize">
                                    {% if stats and stats.database_size_mb is defined %}
                                        {{ "%.2f"|format(stats.database_size_mb|float) }}
                                    {% else %}
                                        0.00
                                    {% endif %}
                                </h2>
                                <small class="text-muted">–†–∞–∑–º–µ—Ä –±–∞–∑—ã (MB)</small>
                            </div>
                        </div>
                    </div>
                    
                    <!-- –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ -->
                    {% if stats and stats.statistics and stats.statistics.categories %}
                    <div class="mt-3">
                        <h6>–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º:</h6>
                        <div class="d-flex flex-wrap gap-2">
                            {% for category, count in stats.statistics.categories.items() %}
                            <span class="badge bg-secondary">
                                {{ category }}: {{ count }}
                            </span>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}
                    
                    <!-- –í—Ä–µ–º—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è -->
                    <div class="mt-3 text-end">
                        <small class="text-muted">
                            <i class="bi bi-clock"></i> –û–±–Ω–æ–≤–ª–µ–Ω–æ: 
                            <span id="updateTime">
                                {% if stats and stats.timestamp %}
                                    {{ stats.timestamp[:16]|replace('T', ' ') }}
                                {% else %}
                                    {{ now().strftime('%Y-%m-%d %H:%M') }}
                                {% endif %}
                            </span>
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- === –ë–´–°–¢–†–´–ï –î–ï–ô–°–¢–í–ò–Ø === -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-success text-white">
                    <i class="bi bi-lightning"></i> –ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6 mb-3 mb-md-0">
                            <button class="btn btn-outline-primary w-100" onclick="collectNewsModal()">
                                <i class="bi bi-cloud-download"></i> –°–æ–±—Ä–∞—Ç—å –Ω–æ–≤–æ—Å—Ç–∏
                            </button>
                        </div>
                        <div class="col-md-6">
                            <a href="/news" class="btn btn-outline-info w-100">
                                <i class="bi bi-newspaper"></i> –ü—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å –Ω–æ–≤–æ—Å—Ç–∏
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- === –ü–û–°–õ–ï–î–ù–ò–ï –ù–û–í–û–°–¢–ò –ò –ê–ù–ê–õ–ò–ó–´ === -->
    <div class="row">
        <!-- –ü–æ—Å–ª–µ–¥–Ω–∏–µ –Ω–æ–≤–æ—Å—Ç–∏ -->
        <div class="col-lg-6 mb-4">
            <div class="card h-100">
                <div class="card-header bg-dark text-white">
                    <i class="bi bi-clock-history"></i> –ü–æ—Å–ª–µ–¥–Ω–∏–µ –Ω–æ–≤–æ—Å—Ç–∏
                </div>
                <div class="card-body">
                    <div id="latestNews">
                        <div class="text-center py-3">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                            </div>
                            <p class="mt-2">–ó–∞–≥—Ä—É–∑–∫–∞ –Ω–æ–≤–æ—Å—Ç–µ–π...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- –ü–æ—Å–ª–µ–¥–Ω–∏–µ –∞–Ω–∞–ª–∏–∑—ã -->
        <div class="col-lg-6 mb-4">
            <div class="card h-100">
                <div class="card-header bg-warning text-dark">
                    <i class="bi bi-graph-up-arrow"></i> –ü–æ—Å–ª–µ–¥–Ω–∏–µ –∞–Ω–∞–ª–∏–∑—ã
                </div>
                <div class="card-body">
                    <div id="latestAnalyses">
                        <div class="text-center py-3">
                            <div class="spinner-border text-warning" role="status">
                                <span class="visually-hidden">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                            </div>
                            <p class="mt-2">–ó–∞–≥—Ä—É–∑–∫–∞ –∞–Ω–∞–ª–∏–∑–æ–≤...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- === –ë–õ–û–ö –î–õ–Ø –£–í–ï–î–û–ú–õ–ï–ù–ò–ô === -->
    <div id="notificationArea" class="mt-3"></div>
    
    <!-- === –ë–õ–û–ö –ê–ù–ê–õ–ò–ó–ê –¢–ï–ú–´ === -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-success text-white">
                    <i class="bi bi-graph-up"></i> –ê–Ω–∞–ª–∏–∑ —Ç–µ–º—ã
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-8">
                            <div class="mb-3">
                                <label for="topicInput" class="form-label">–í–≤–µ–¥–∏—Ç–µ —Ç–µ–º—É –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞:</label>
                                <input type="text" class="form-control" id="topicInput" 
                                       placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –∏—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω—ã–π –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç, –ø–æ–ª–∏—Ç–∏–∫–∞, —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏...">
                                <div class="form-text">–ê–≥–µ–Ω—Ç –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –Ω–æ–≤–æ—Å—Ç–∏ –ø–æ —ç—Ç–æ–π —Ç–µ–º–µ —Å –ø–æ–º–æ—â—å—é –ò–ò</div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <button class="btn btn-success w-100 mt-4" onclick="startTopicAnalysis()">
                                <i class="bi bi-graph-up"></i> –ê–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–º—É
                            </button>
                        </div>
                    </div>
                    
                    <!-- –ü—Ä–æ–≥—Ä–µ—Å—Å –∞–Ω–∞–ª–∏–∑–∞ -->
                    <div id="analysisStatus" class="mt-3" style="display: none;">
                        <div class="progress mb-2" style="height: 25px;">
                            <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                 id="analysisProgress" style="width: 0%">
                                <span id="progressText">0%</span>
                            </div>
                        </div>
                        <div class="small text-muted" id="analysisMessage"></div>
                    </div>
                    
                    <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏–∑–∞ -->
                    <div id="analysisResult" class="mt-3"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å–±–æ—Ä–∞ –Ω–æ–≤–æ—Å—Ç–µ–π -->
<div class="modal fade" id="collectModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-cloud-download"></i> –°–±–æ—Ä –Ω–æ–≤–æ—Å—Ç–µ–π</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="collectLimit" class="form-label">
                        –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç–∞—Ç–µ–π —Å –∫–∞–∂–¥–æ–≥–æ –∏—Å—Ç–æ—á–Ω–∏–∫–∞:
                    </label>
                    <input type="range" class="form-range" id="collectLimit" min="1" max="10" value="3">
                    <div class="d-flex justify-content-between">
                        <small>1</small>
                        <small id="collectLimitValue">3</small>
                        <small>10</small>
                    </div>
                </div>
                <div class="progress mb-3 d-none" id="collectProgress">
                    <div class="progress-bar progress-bar-striped progress-bar-animated" 
                         style="width: 0%"></div>
                </div>
                <div id="collectResult"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                <button type="button" class="btn btn-primary" onclick="startCollection()">
                    <i class="bi bi-play-fill"></i> –ù–∞—á–∞—Ç—å —Å–±–æ—Ä
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –∞–Ω–∞–ª–∏–∑–∞ —Ç–µ–º—ã
async function startTopicAnalysis() {
    const topicInput = document.getElementById('topicInput');
    const topic = topicInput.value.trim();
    
    if (!topic) {
        showNotification('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–º—É –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞!', 'warning');
        topicInput.focus();
        return;
    }
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
    const statusDiv = document.getElementById('analysisStatus');
    const progressBar = document.getElementById('analysisProgress');
    const progressText = document.getElementById('progressText');
    const messageDiv = document.getElementById('analysisMessage');
    const resultDiv = document.getElementById('analysisResult');
    
    statusDiv.style.display = 'block';
    resultDiv.innerHTML = '';
    progressBar.style.width = '10%';
    progressBar.className = 'progress-bar progress-bar-striped progress-bar-animated bg-warning';
    progressText.textContent = '10%';
    messageDiv.textContent = '–ó–∞–ø—É—Å–∫ –∞–Ω–∞–ª–∏–∑–∞...';
    
    try {
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ñ—É–Ω–∫—Ü–∏—é –∏–∑ extra_js
        const response = await analyzeTopicAPI(topic);
        
        if (response.success) {
            const taskId = response.task_id;
            messageDiv.textContent = `–ê–Ω–∞–ª–∏–∑ –∑–∞–ø—É—â–µ–Ω. ID: ${taskId}`;
            progressBar.style.width = '30%';
            progressText.textContent = '30%';
            
            // –û—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
            trackAnalysisProgressAPI(
                taskId,
                // onComplete
                (result) => {
                    progressBar.style.width = '100%';
                    progressBar.className = 'progress-bar bg-success';
                    progressText.textContent = '100%';
                    messageDiv.textContent = '–ê–Ω–∞–ª–∏–∑ –∑–∞–≤–µ—Ä—à–µ–Ω!';
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –≤ –∫—Ä–∞—Å–∏–≤–æ–º —Ñ–æ—Ä–º–∞—Ç–µ
                    displayStyledAnalysisResult(result, resultDiv);
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
                    updateSystemStatus();
                    loadLatestAnalyses();
                    
                    setTimeout(() => {
                        statusDiv.style.display = 'none';
                    }, 3000);
                },
                // onError
                (error) => {
                    progressBar.style.width = '100%';
                    progressBar.className = 'progress-bar bg-danger';
                    progressText.textContent = '–û—à–∏–±–∫–∞';
                    messageDiv.textContent = '–û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞';
                    
                    resultDiv.innerHTML = `
                        <div class="alert alert-danger">
                            <i class="bi bi-exclamation-triangle"></i> –û—à–∏–±–∫–∞: ${error}
                        </div>
                    `;
                },
                // onProgress
                (progress) => {
                    const percent = 30 + (progress * 0.7);
                    progressBar.style.width = `${percent}%`;
                    progressText.textContent = `${Math.round(percent)}%`;
                }
            );
            
            showNotification(`–ê–Ω–∞–ª–∏–∑ —Ç–µ–º—ã "${topic}" –∑–∞–ø—É—â–µ–Ω!`, 'success');
        } else {
            statusDiv.style.display = 'none';
            resultDiv.innerHTML = `
                <div class="alert alert-danger">
                    <i class="bi bi-exclamation-triangle"></i> –û—à–∏–±–∫–∞: ${response.error}
                </div>
            `;
            showNotification('–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –∞–Ω–∞–ª–∏–∑–∞', 'error');
        }
    } catch (error) {
        statusDiv.style.display = 'none';
        resultDiv.innerHTML = `
            <div class="alert alert-danger">
                <i class="bi bi-exclamation-triangle"></i> –û—à–∏–±–∫–∞: ${error.message}
            </div>
        `;
        showNotification('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º', 'error');
    }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å—Ç–∏–ª–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –∞–Ω–∞–ª–∏–∑–∞
function displayStyledAnalysisResult(result, container) {
    if (!result) {
        container.innerHTML = `
            <div class="alert alert-info">
                <i class="bi bi-info-circle"></i> –ê–Ω–∞–ª–∏–∑ –∑–∞–≤–µ—Ä—à–µ–Ω, –Ω–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –Ω–µ –ø–æ–ª—É—á–µ–Ω—ã
            </div>
        `;
        return;
    }
    
    let html = '';
    
    // –ï—Å–ª–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç - –æ–±—ä–µ–∫—Ç (–∫–∞–∫ –≤ –≤–∞—à–µ–º –ø—Ä–∏–º–µ—Ä–µ)
    if (typeof result === 'object' && result.analysis) {
        const analysis = result.analysis || '';
        const topic = result.topic || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è —Ç–µ–º–∞';
        const keywords = result.keywords || [];
        const relevantNewsCount = result.relevant_news_count || 0;
        const analysisTime = result.analysis_time_seconds ? result.analysis_time_seconds.toFixed(2) : '0';
        const timestamp = result.timestamp || new Date().toISOString();
        
        // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –∞–Ω–∞–ª–∏–∑: –∑–∞–º–µ–Ω—è–µ–º **–∂–∏—Ä–Ω—ã–π —Ç–µ–∫—Å—Ç** –∏ —Ä–∞–∑–±–∏–≤–∞–µ–º –Ω–∞ —Å–µ–∫—Ü–∏–∏
        const formattedAnalysis = analysis
            .replace(/\\n/g, '\n')
            .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
            .replace(/\n/g, '<br>');
        
        // –†–∞–∑–¥–µ–ª—è–µ–º –Ω–∞ —Å–µ–∫—Ü–∏–∏
        const sections = formattedAnalysis.split('<br><br>');
        
        html = `
            <div class="analysis-result">
                <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ –∞–Ω–∞–ª–∏–∑–∞ -->
                <div class="card border-success mb-4">
                    <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                        <div>
                            <i class="bi bi-graph-up"></i>
                            <strong>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏–∑–∞ —Ç–µ–º—ã: "${topic}"</strong>
                        </div>
                        <div class="badge bg-light text-dark">
                            <i class="bi bi-clock"></i> ${parseFloat(analysisTime)} —Å–µ–∫
                        </div>
                    </div>
                    <div class="card-body">
                        <!-- –ë—ã—Å—Ç—Ä–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <div class="card bg-light">
                                    <div class="card-body text-center">
                                        <h5 class="card-title"><i class="bi bi-newspaper text-primary"></i></h5>
                                        <h3 class="text-primary">${relevantNewsCount}</h3>
                                        <p class="card-text">–ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –Ω–æ–≤–æ—Å—Ç–µ–π</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card bg-light">
                                    <div class="card-body text-center">
                                        <h5 class="card-title"><i class="bi bi-tags text-success"></i></h5>
                                        <div class="d-flex flex-wrap justify-content-center gap-2">
                                            ${keywords.map(keyword => 
                                                `<span class="badge bg-info">${keyword}</span>`
                                            ).join('')}
                                        </div>
                                        <p class="card-text mt-2">–∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∞–Ω–∞–ª–∏–∑ -->
                        <div class="analysis-content">
        `;
        
        // –î–æ–±–∞–≤–ª—è–µ–º –∫–∞–∂–¥—É—é —Å–µ–∫—Ü–∏—é —Å –∫—Ä–∞—Å–∏–≤—ã–º –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ–º
        sections.forEach((section, index) => {
            if (section.trim()) {
                // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø —Å–µ–∫—Ü–∏–∏ –ø–æ –∑–∞–≥–æ–ª–æ–≤–∫—É
                if (section.includes('–û–°–ù–û–í–ù–´–ï –ê–°–ü–ï–ö–¢–´')) {
                    html += `
                        <div class="analysis-section mb-4">
                            <div class="section-header bg-primary text-white p-3 rounded-top">
                                <h5 class="mb-0"><i class="bi bi-list-ul"></i> –û—Å–Ω–æ–≤–Ω—ã–µ –∞—Å–ø–µ–∫—Ç—ã —Ç–µ–º—ã</h5>
                            </div>
                            <div class="section-content p-3 border rounded-bottom">
                                <div class="aspects-list">
                                    ${section.replace('*–û–°–ù–û–í–ù–´–ï –ê–°–ü–ï–ö–¢–´ –¢–ï–ú–´*<br>', '')}
                                </div>
                            </div>
                        </div>
                    `;
                } else if (section.includes('–ö–õ–Æ–ß–ï–í–´–ï –§–ê–ö–¢–´')) {
                    html += `
                        <div class="analysis-section mb-4">
                            <div class="section-header bg-info text-white p-3 rounded-top">
                                <h5 class="mb-0"><i class="bi bi-lightbulb"></i> –ö–ª—é—á–µ–≤—ã–µ —Ñ–∞–∫—Ç—ã –∏ —Ç–µ–Ω–¥–µ–Ω—Ü–∏–∏</h5>
                            </div>
                            <div class="section-content p-3 border rounded-bottom">
                                ${section.replace('**–ö–õ–Æ–ß–ï–í–´–ï –§–ê–ö–¢–´ –ò –¢–ï–ù–î–ï–ù–¶–ò–ò**<br>', '')}
                            </div>
                        </div>
                    `;
                } else if (section.includes('–í–û–ó–ú–û–ñ–ù–´–ï –ü–†–ò–ß–ò–ù–´')) {
                    html += `
                        <div class="analysis-section mb-4">
                            <div class="section-header bg-warning text-dark p-3 rounded-top">
                                <h5 class="mb-0"><i class="bi bi-question-circle"></i> –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã –∏ —Å–ª–µ–¥—Å—Ç–≤–∏—è</h5>
                            </div>
                            <div class="section-content p-3 border rounded-bottom">
                                ${section.replace('**–í–û–ó–ú–û–ñ–ù–´–ï –ü–†–ò–ß–ò–ù–´ –ò –°–õ–ï–î–°–¢–í–ò–Ø**<br>', '')}
                            </div>
                        </div>
                    `;
                } else if (section.includes('–ü–ï–†–°–ü–ï–ö–¢–ò–í–´')) {
                    html += `
                        <div class="analysis-section mb-4">
                            <div class="section-header bg-success text-white p-3 rounded-top">
                                <h5 class="mb-0"><i class="bi bi-binoculars"></i> –ü–µ—Ä—Å–ø–µ–∫—Ç–∏–≤—ã –∏ –ø—Ä–æ–≥–Ω–æ–∑—ã</h5>
                            </div>
                            <div class="section-content p-3 border rounded-bottom">
                                ${section.replace('**–ü–ï–†–°–ü–ï–ö–¢–ò–í–´ –ò –ü–†–û–ì–ù–û–ó–´**<br>', '')}
                            </div>
                        </div>
                    `;
                } else if (section.includes('–í–´–í–û–î–´')) {
                    html += `
                        <div class="analysis-section mb-4">
                            <div class="section-header bg-danger text-white p-3 rounded-top">
                                <h5 class="mb-0"><i class="bi bi-check-circle"></i> –í—ã–≤–æ–¥—ã –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏</h5>
                            </div>
                            <div class="section-content p-3 border rounded-bottom">
                                ${section.replace('**–í–´–í–û–î–´ –ò –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò**<br>', '')}
                            </div>
                        </div>
                    `;
                } else {
                    // –û–±—â–∞—è —Å–µ–∫—Ü–∏—è
                    html += `
                        <div class="analysis-section mb-4">
                            <div class="section-content p-3 border rounded">
                                ${section}
                            </div>
                        </div>
                    `;
                }
            }
        });
        
        html += `
                        </div>
                    </div>
                    <div class="card-footer text-muted">
                        <div class="d-flex justify-content-between align-items-center">
                            <small>
                                <i class="bi bi-calendar"></i> 
                                ${new Date(timestamp).toLocaleDateString('ru-RU', {
                                    day: '2-digit',
                                    month: '2-digit',
                                    year: 'numeric',
                                    hour: '2-digit',
                                    minute: '2-digit'
                                })}
                            </small>
                            <button class="btn btn-sm btn-outline-secondary" onclick="copyAnalysisToClipboard()">
                                <i class="bi bi-clipboard"></i> –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –æ—Ç—á–µ—Ç
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- –°—ã—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ (—Å–∫—Ä—ã—Ç—ã –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) -->
                <div class="mt-3">
                    <button class="btn btn-sm btn-outline-info" onclick="toggleRawData(this)">
                        <i class="bi bi-code"></i> –ü–æ–∫–∞–∑–∞—Ç—å —Å—ã—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ
                    </button>
                    <div id="rawAnalysisData" style="display: none; margin-top: 10px;">
                        <pre class="bg-light p-3 border rounded" style="max-height: 300px; overflow: auto;">
${JSON.stringify(result, null, 2)}
                        </pre>
                    </div>
                </div>
            </div>
        `;
    } else {
        // –ï—Å–ª–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –Ω–µ –≤ –æ–∂–∏–¥–∞–µ–º–æ–º —Ñ–æ—Ä–º–∞—Ç–µ, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–∞–∫ –µ—Å—Ç—å
        html = `
            <div class="card border-success">
                <div class="card-header bg-success text-white">
                    <i class="bi bi-check-circle"></i> –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏–∑–∞
                </div>
                <div class="card-body">
                    <pre style="white-space: pre-wrap;">${typeof result === 'object' ? JSON.stringify(result, null, 2) : result}</pre>
                </div>
            </div>
        `;
    }
    
    container.innerHTML = html;
}

// –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
function toggleRawData(button) {
    const rawDataDiv = document.getElementById('rawAnalysisData');
    if (rawDataDiv.style.display === 'none') {
        rawDataDiv.style.display = 'block';
        button.innerHTML = '<i class="bi bi-code-slash"></i> –°–∫—Ä—ã—Ç—å —Å—ã—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ';
    } else {
        rawDataDiv.style.display = 'none';
        button.innerHTML = '<i class="bi bi-code"></i> –ü–æ–∫–∞–∑–∞—Ç—å —Å—ã—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ';
    }
}

function copyAnalysisToClipboard() {
    const analysisText = document.querySelector('.analysis-content')?.innerText || '';
    if (analysisText) {
        navigator.clipboard.writeText(analysisText).then(() => {
            showNotification('–û—Ç—á–µ—Ç —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!', 'success');
        }).catch(err => {
            console.error('–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è:', err);
            showNotification('–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è', 'error');
        });
    }
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ª–∞–π–¥–µ—Ä–∞ —Å–±–æ—Ä–∞ –Ω–æ–≤–æ—Å—Ç–µ–π
document.addEventListener('DOMContentLoaded', function() {
    const collectSlider = document.getElementById('collectLimit');
    if (collectSlider) {
        collectSlider.addEventListener('input', function() {
            document.getElementById('collectLimitValue').textContent = this.value;
        });
    }
    
    // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ
    loadLatestNews();
    loadLatestAnalyses();
    updateSystemStatus();
});
</script>
{% endblock %}

{% block extra_js %}
<script>
// –û–±–Ω–æ–≤–ª—è–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ —Å–ª–∞–π–¥–µ—Ä–∞
document.getElementById('collectLimit').addEventListener('input', function() {
    document.getElementById('collectLimitValue').textContent = this.value;
});

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
function showNotification(message, type = 'info') {
    const types = {
        'success': 'alert-success',
        'error': 'alert-danger', 
        'warning': 'alert-warning',
        'info': 'alert-info'
    };
    
    const alertClass = types[type] || 'alert-info';
    
    const alert = `
        <div class="alert ${alertClass} alert-dismissible fade show" role="alert">
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;
    
    $('#notificationArea').append(alert);
    
    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–∫—Ä—ã—Ç–∏–µ —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
    setTimeout(() => {
        $('.alert').alert('close');
    }, 5000);
}

// –§—É–Ω–∫—Ü–∏—è —Å–±–æ—Ä–∞ –Ω–æ–≤–æ—Å—Ç–µ–π
function collectNewsModal() {
    $('#collectModal').modal('show');
}

// –ù–∞—á–∞–ª–æ —Å–±–æ—Ä–∞ –Ω–æ–≤–æ—Å—Ç–µ–π
function startCollection() {
    const limit = document.getElementById('collectLimit').value;
    
    $('#collectProgress').removeClass('d-none');
    $('#collectResult').html('');
    
    $.ajax({
        url: '/api/collect',
        type: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({ limit: parseInt(limit) }),
        success: function(response) {
            if (response.success) {
                $('#collectResult').html(`
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i> ${response.message}
                        <br><small>ID –∑–∞–¥–∞—á–∏: ${response.task_id}</small>
                    </div>
                `);
                
                // –ù–∞—á–∏–Ω–∞–µ–º –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å
                trackCollectionProgress(response.task_id);
            }
        },
        error: function(xhr) {
            $('#collectResult').html(`
                <div class="alert alert-danger">
                    <i class="bi bi-exclamation-triangle"></i> –û—à–∏–±–∫–∞: ${xhr.responseJSON?.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}
                </div>
            `);
        }
    });
}

// –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ —Å–±–æ—Ä–∞
function trackCollectionProgress(taskId) {
    const interval = setInterval(() => {
        $.get(`/api/task/${taskId}`, function(task) {
            if (task.status === 'completed') {
                clearInterval(interval);
                $('#collectProgress .progress-bar').css('width', '100%');
                $('#collectResult').html(`
                    <div class="alert alert-success">
                        <i class="bi bi-check-circle"></i> –°–±–æ—Ä –Ω–æ–≤–æ—Å—Ç–µ–π —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω!
                    </div>
                `);
                showNotification('–ù–æ–≤–æ—Å—Ç–∏ —É—Å–ø–µ—à–Ω–æ —Å–æ–±—Ä–∞–Ω—ã!', 'success');
                loadLatestNews(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –Ω–æ–≤–æ—Å—Ç–µ–π
                setTimeout(() => $('#collectModal').modal('hide'), 2000);
            } else if (task.status === 'error') {
                clearInterval(interval);
                $('#collectResult').html(`
                    <div class="alert alert-danger">
                        <i class="bi bi-exclamation-triangle"></i> –û—à–∏–±–∫–∞: ${task.error}
                    </div>
                `);
            } else if (task.status === 'running') {
                const progress = task.progress || 0;
                $('#collectProgress .progress-bar').css('width', `${progress}%`);
            }
        });
    }, 1000);
}

// –ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –Ω–æ–≤–æ—Å—Ç–µ–π
function loadLatestNews() {
    $.get('/api/search?limit=5', function(data) {
        if (data.success && data.results && data.results.length > 0) {
            let html = '';
            data.results.forEach(news => {
                html += `
                    <div class="news-item mb-3">
                        <div class="d-flex justify-content-between align-items-start">
                            <h6 class="mb-1">
                                <a href="${news.url || '#'}" target="_blank" class="text-decoration-none">${news.title || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è'}</a>
                            </h6>
                            <span class="badge ${news.category_color || 'bg-secondary'}">${news.category || '—Ä–∞–∑–Ω–æ–µ'}</span>
                        </div>
                        <p class="mb-1 text-muted small">
                            <i class="bi bi-newspaper"></i> ${news.source || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫'} ‚Ä¢ 
                            <i class="bi bi-clock"></i> ${news.published || '–î–∞—Ç–∞ –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞'}
                        </p>
                        ${news.summary ? `<p class="small">${news.summary}</p>` : ''}
                        <hr>
                    </div>
                `;
            });
            $('#latestNews').html(html);
        } else {
            $('#latestNews').html(`
                <div class="text-center py-4">
                    <i class="bi bi-inbox display-4 text-muted"></i>
                    <p class="mt-2">–ù–æ–≤–æ—Å—Ç–µ–π –ø–æ–∫–∞ –Ω–µ—Ç</p>
                    <button class="btn btn-sm btn-outline-primary" onclick="collectNewsModal()">
                        <i class="bi bi-cloud-download"></i> –°–æ–±—Ä–∞—Ç—å –Ω–æ–≤–æ—Å—Ç–∏
                    </button>
                </div>
            `);
        }
    });
}

// === –§–£–ù–ö–¶–ò–ò –î–õ–Ø –ê–ù–ê–õ–ò–ó–ê –¢–ï–ú–´ ===

// API —Ñ—É–Ω–∫—Ü–∏—è –∞–Ω–∞–ª–∏–∑–∞ —Ç–µ–º—ã (–±–µ–∑ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤)
async function analyzeTopicAPI(topic) {
    try {
        const response = await fetch('/api/analyze', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ topic: topic })
        });
        
        return await response.json();
    } catch (error) {
        return { success: false, error: error.message };
    }
}

// –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –∞–Ω–∞–ª–∏–∑–∞
async function trackAnalysisProgressAPI(taskId, onComplete, onError, onProgress) {
    const maxAttempts = 120; // –ú–∞–∫—Å–∏–º—É–º 2 –º–∏–Ω—É—Ç—ã
    let attempts = 0;
    
    const checkStatus = async () => {
        attempts++;
        
        try {
            const response = await fetch(`/api/task/${taskId}`);
            const task = await response.json();
            
            if (task.status === 'completed') {
                if (onComplete) onComplete(task.result);
                return true;
            } else if (task.status === 'error') {
                if (onError) onError(task.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞');
                return true;
            } else if (task.status === 'running') {
                if (onProgress) onProgress(task.progress || 0);
                
                // –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É
                if (attempts < maxAttempts) {
                    setTimeout(checkStatus, 1000);
                } else {
                    if (onError) onError('–¢–∞–π–º–∞—É—Ç –∞–Ω–∞–ª–∏–∑–∞');
                }
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å–∞:', error);
            // –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –ø—Ä–æ–±–æ–≤–∞—Ç—å
            if (attempts < maxAttempts) {
                setTimeout(checkStatus, 1000);
            } else {
                if (onError) onError('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è');
            }
        }
    };
    
    // –ù–∞—á–∏–Ω–∞–µ–º –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ
    setTimeout(checkStatus, 1000);
}

// –ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –∞–Ω–∞–ª–∏–∑–æ–≤
function loadLatestAnalyses() {
    $.get('/api/statistics/detailed', function(data) {
        if (data.success && data.recent_analyses && data.recent_analyses.length > 0) {
            let html = '<div class="list-group">';
            data.recent_analyses.slice(0, 3).forEach(analysis => {
                html += `
                    <div class="list-group-item">
                        <div class="d-flex w-100 justify-content-between">
                            <h6 class="mb-1">${analysis.query || '–ê–Ω–∞–ª–∏–∑'}</h6>
                            <small>${analysis.created_at ? analysis.created_at.slice(0, 10) : '–î–∞—Ç–∞ –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞'}</small>
                        </div>
                        <small class="text-muted">–ù–∞–∂–º–∏—Ç–µ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –ø–æ–ª–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞</small>
                    </div>
                `;
            });
            html += '</div>';
            $('#latestAnalyses').html(html);
        } else {
            $('#latestAnalyses').html(`
                <div class="text-center py-3">
                    <i class="bi bi-graph-up display-4 text-muted"></i>
                    <p class="mt-2">–ê–Ω–∞–ª–∏–∑–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç</p>
                    <button class="btn btn-sm btn-outline-warning" onclick="document.getElementById('topicInput').focus()">
                        <i class="bi bi-graph-up"></i> –°–æ–∑–¥–∞—Ç—å –∞–Ω–∞–ª–∏–∑
                    </button>
                </div>
            `);
        }
    }).fail(function() {
        $('#latestAnalyses').html(`
            <div class="text-center py-3">
                <i class="bi bi-graph-up display-4 text-muted"></i>
                <p class="mt-2">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∞–Ω–∞–ª–∏–∑—ã</p>
            </div>
        `);
    });
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ —Å–∏—Å—Ç–µ–º—ã
function updateSystemStatus() {
    $.get('/api/status', function(status) {
        if (status.error) {
            $('#statusIndicator').html(`
                <i class="bi bi-circle-fill text-danger"></i>
                <span class="ms-1">–û—à–∏–±–∫–∞: ${status.error}</span>
            `);
        } else {
            const newsCount = status.statistics?.total_news || 0;
            $('#statusIndicator').html(`
                <i class="bi bi-circle-fill text-success"></i>
                <span class="ms-1">–°–∏—Å—Ç–µ–º–∞ –∞–∫—Ç–∏–≤–Ω–∞ (${newsCount} –Ω–æ–≤–æ—Å—Ç–µ–π)</span>
            `);
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Ü–∏—Ñ—Ä—ã —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
            if (status.statistics) {
                if (status.statistics.total_news !== undefined) {
                    $('#totalNews').text(status.statistics.total_news);
                }
                if (status.statistics.analyzed_news !== undefined) {
                    $('#analyzedNews').text(status.statistics.analyzed_news);
                }
                if (status.statistics.total_analyses !== undefined) {
                    $('#totalAnalyses').text(status.statistics.total_analyses);
                }
            }
            if (status.database_size_mb !== undefined) {
                $('#dbSize').text(status.database_size_mb.toFixed(2));
            }
            if (status.timestamp) {
                $('#updateTime').text(status.timestamp.replace('T', ' ').substring(0, 16));
            }
        }
    }).fail(function() {
        $('#statusIndicator').html(`
            <i class="bi bi-circle-fill text-danger"></i>
            <span class="ms-1">–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è</span>
        `);
    });
}

// –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
$(document).ready(function() {
    loadLatestNews();
    loadLatestAnalyses();
    
    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ —Å–∏—Å—Ç–µ–º—ã –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
    setInterval(updateSystemStatus, 30000);
});
</script>
{% endblock %}