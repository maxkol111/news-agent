{% extends "base.html" %}

{% block title %}ü§ñ –ì–ª–∞–≤–Ω–∞—è - –ù–æ–≤–æ—Å—Ç–Ω–æ–π –ò–ò-–∞–≥–µ–Ω—Ç{% endblock %}

{% block content %}
<div class="row">
    <!-- –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞: –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏ –±—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è -->
    <div class="col-lg-4 mb-4">
        <!-- –°—Ç–∞—Ç—É—Å —Å–∏—Å—Ç–µ–º—ã -->
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <i class="bi bi-speedometer2"></i> –°—Ç–∞—Ç—É—Å —Å–∏—Å—Ç–µ–º—ã
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-6 mb-3">
                        <div class="stat-card">
                            <h2 class="text-primary">{{ stats.statistics.total_news }}</h2>
                            <small class="text-muted">–ù–æ–≤–æ—Å—Ç–µ–π –≤ –±–∞–∑–µ</small>
                        </div>
                    </div>
                    <div class="col-6 mb-3">
                        <div class="stat-card">
                            <h2 class="text-success">{{ stats.statistics.analyzed_news }}</h2>
                            <small class="text-muted">–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ</small>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="stat-card">
                            <h2 class="text-warning">{{ stats.statistics.total_analyses }}</h2>
                            <small class="text-muted">–ê–Ω–∞–ª–∏–∑–æ–≤ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ</small>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="stat-card">
                            <h2 class="text-info">{{ stats.database_size_mb|round(2) }}</h2>
                            <small class="text-muted">–†–∞–∑–º–µ—Ä –±–∞–∑—ã (MB)</small>
                        </div>
                    </div>
                </div>
                <div class="mt-3">
                    <small class="text-muted">
                        <i class="bi bi-clock"></i> –û–±–Ω–æ–≤–ª–µ–Ω–æ: {{ stats.timestamp[:16].replace('T', ' ') }}
                    </small>
                </div>
            </div>
        </div>

        <!-- –ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è -->
        <div class="card mb-4">
            <div class="card-header bg-success text-white">
                <i class="bi bi-lightning"></i> –ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <button class="btn btn-outline-primary" onclick="collectNews()">
                        <i class="bi bi-cloud-download"></i> –°–æ–±—Ä–∞—Ç—å –Ω–æ–≤–æ—Å—Ç–∏
                    </button>
                    <a href="{{ url_for('analyze_page') }}" class="btn btn-outline-warning">
                        <i class="bi bi-graph-up"></i> –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–º—É
                    </a>
                    <a href="{{ url_for('news_page') }}" class="btn btn-outline-info">
                        <i class="bi bi-newspaper"></i> –ü—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å –Ω–æ–≤–æ—Å—Ç–∏
                    </a>
                </div>
            </div>
        </div>

        <!-- –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –Ω–æ–≤–æ—Å—Ç–µ–π -->
        {% if stats.statistics.categories %}
        <div class="card">
            <div class="card-header bg-info text-white">
                <i class="bi bi-tags"></i> –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
            </div>
            <div class="card-body">
                <ul class="list-group list-group-flush">
                    {% for category, count in stats.statistics.categories.items() %}
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <span>
                            <span class="badge bg-{{ get_category_color(category) }} me-2">{{ category }}</span>
                        </span>
                        <span class="badge bg-secondary rounded-pill">{{ count }}</span>
                    </li>
                    {% endfor %}
                </ul>
            </div>
        </div>
        {% endif %}
    </div>

    <!-- –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–∞—è –∫–æ–ª–æ–Ω–∫–∞: –ü–æ—Å–ª–µ–¥–Ω–∏–µ –Ω–æ–≤–æ—Å—Ç–∏ -->
    <div class="col-lg-8 mb-4">
        <div class="card">
            <div class="card-header bg-dark text-white">
                <i class="bi bi-clock-history"></i> –ü–æ—Å–ª–µ–¥–Ω–∏–µ –Ω–æ–≤–æ—Å—Ç–∏
            </div>
            <div class="card-body">
                <div id="latestNews">
                    <div class="text-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                        </div>
                        <p class="mt-2">–ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –Ω–æ–≤–æ—Å—Ç–µ–π...</p>
                    </div>
                </div>
                <div class="text-center mt-3">
                    <a href="{{ url_for('news_page') }}" class="btn btn-outline-dark">
                        <i class="bi bi-arrow-right"></i> –í—Å–µ –Ω–æ–≤–æ—Å—Ç–∏
                    </a>
                </div>
            </div>
        </div>

        <!-- –ü–æ—Å–ª–µ–¥–Ω–∏–µ –∞–Ω–∞–ª–∏–∑—ã -->
        <div class="card mt-4">
            <div class="card-header bg-warning text-dark">
                <i class="bi bi-graph-up-arrow"></i> –ü–æ—Å–ª–µ–¥–Ω–∏–µ –∞–Ω–∞–ª–∏–∑—ã
            </div>
            <div class="card-body">
                <div id="latestAnalyses">
                    <div class="text-center">
                        <div class="spinner-border text-warning" role="status">
                            <span class="visually-hidden">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                        </div>
                        <p class="mt-2">–ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –∞–Ω–∞–ª–∏–∑–æ–≤...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å–±–æ—Ä–∞ –Ω–æ–≤–æ—Å—Ç–µ–π -->
<div class="modal fade" id="collectModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-cloud-download"></i> –°–±–æ—Ä –Ω–æ–≤–æ—Å—Ç–µ–π</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="collectLimit" class="form-label">
                        –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç–∞—Ç–µ–π —Å –∫–∞–∂–¥–æ–≥–æ –∏—Å—Ç–æ—á–Ω–∏–∫–∞:
                    </label>
                    <input type="range" class="form-range" id="collectLimit" min="1" max="10" value="3">
                    <div class="d-flex justify-content-between">
                        <small>1</small>
                        <small id="collectLimitValue">3</small>
                        <small>10</small>
                    </div>
                </div>
                <div class="progress mb-3 d-none" id="collectProgress">
                    <div class="progress-bar progress-bar-striped progress-bar-animated" 
                         style="width: 0%"></div>
                </div>
                <div id="collectResult"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                <button type="button" class="btn btn-primary" onclick="startCollection()">
                    <i class="bi bi-play-fill"></i> –ù–∞—á–∞—Ç—å —Å–±–æ—Ä
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// –û–±–Ω–æ–≤–ª—è–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ —Å–ª–∞–π–¥–µ—Ä–∞
document.getElementById('collectLimit').addEventListener('input', function() {
    document.getElementById('collectLimitValue').textContent = this.value;
});

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
function showNotification(message, type = 'info') {
    const types = {
        'success': 'alert-success',
        'error': 'alert-danger', 
        'warning': 'alert-warning',
        'info': 'alert-info'
    };
    
    const alertClass = types[type] || 'alert-info';
    
    const alert = `
        <div class="alert ${alertClass} alert-dismissible fade show" role="alert">
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;
    
    $('#notificationArea').append(alert);
    
    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–∫—Ä—ã—Ç–∏–µ —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
    setTimeout(() => {
        $('.alert').alert('close');
    }, 5000);
}

// –§—É–Ω–∫—Ü–∏—è —Å–±–æ—Ä–∞ –Ω–æ–≤–æ—Å—Ç–µ–π
function collectNews() {
    $('#collectModal').modal('show');
}

// –ù–∞—á–∞–ª–æ —Å–±–æ—Ä–∞ –Ω–æ–≤–æ—Å—Ç–µ–π
function startCollection() {
    const limit = document.getElementById('collectLimit').value;
    
    $('#collectProgress').removeClass('d-none');
    $('#collectResult').html('');
    
    $.ajax({
        url: '/api/collect',
        type: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({ limit: parseInt(limit) }),
        success: function(response) {
            if (response.success) {
                $('#collectResult').html(`
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i> ${response.message}
                        <br><small>ID –∑–∞–¥–∞—á–∏: ${response.task_id}</small>
                    </div>
                `);
                
                // –ù–∞—á–∏–Ω–∞–µ–º –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å
                trackCollectionProgress(response.task_id);
            }
        },
        error: function(xhr) {
            $('#collectResult').html(`
                <div class="alert alert-danger">
                    <i class="bi bi-exclamation-triangle"></i> –û—à–∏–±–∫–∞: ${xhr.responseJSON?.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}
                </div>
            `);
        }
    });
}

// –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ —Å–±–æ—Ä–∞
function trackCollectionProgress(taskId) {
    const interval = setInterval(() => {
        $.get(`/api/task/${taskId}`, function(task) {
            if (task.status === 'completed') {
                clearInterval(interval);
                $('#collectProgress .progress-bar').css('width', '100%');
                $('#collectResult').html(`
                    <div class="alert alert-success">
                        <i class="bi bi-check-circle"></i> –°–±–æ—Ä –Ω–æ–≤–æ—Å—Ç–µ–π —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω!
                    </div>
                `);
                showNotification('–ù–æ–≤–æ—Å—Ç–∏ —É—Å–ø–µ—à–Ω–æ —Å–æ–±—Ä–∞–Ω—ã!', 'success');
                loadLatestNews(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –Ω–æ–≤–æ—Å—Ç–µ–π
                setTimeout(() => $('#collectModal').modal('hide'), 2000);
            } else if (task.status === 'error') {
                clearInterval(interval);
                $('#collectResult').html(`
                    <div class="alert alert-danger">
                        <i class="bi bi-exclamation-triangle"></i> –û—à–∏–±–∫–∞: ${task.error}
                    </div>
                `);
            } else if (task.status === 'running') {
                const progress = task.progress || 0;
                $('#collectProgress .progress-bar').css('width', `${progress}%`);
            }
        });
    }, 1000);
}

// –ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –Ω–æ–≤–æ—Å—Ç–µ–π
function loadLatestNews() {
    $.get('/api/search?limit=5', function(data) {
        if (data.success && data.results.length > 0) {
            let html = '';
            data.results.forEach(news => {
                html += `
                    <div class="news-item mb-3">
                        <div class="d-flex justify-content-between align-items-start">
                            <h6 class="mb-1">
                                <a href="${news.url}" target="_blank" class="text-decoration-none">${news.title}</a>
                            </h6>
                            <span class="badge ${news.category_color}">${news.category}</span>
                        </div>
                        <p class="mb-1 text-muted small">
                            <i class="bi bi-newspaper"></i> ${news.source} ‚Ä¢ 
                            <i class="bi bi-clock"></i> ${news.published}
                        </p>
                        ${news.summary ? `<p class="small">${news.summary}</p>` : ''}
                        <hr>
                    </div>
                `;
            });
            $('#latestNews').html(html);
        } else {
            $('#latestNews').html(`
                <div class="text-center py-4">
                    <i class="bi bi-inbox display-4 text-muted"></i>
                    <p class="mt-2">–ù–æ–≤–æ—Å—Ç–µ–π –ø–æ–∫–∞ –Ω–µ—Ç</p>
                    <button class="btn btn-sm btn-outline-primary" onclick="collectNews()">
                        <i class="bi bi-cloud-download"></i> –°–æ–±—Ä–∞—Ç—å –Ω–æ–≤–æ—Å—Ç–∏
                    </button>
                </div>
            `);
        }
    });
}

// –ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –∞–Ω–∞–ª–∏–∑–æ–≤
function loadLatestAnalyses() {
    $.get('/api/statistics/detailed', function(data) {
        if (data.success && data.recent_analyses.length > 0) {
            let html = '<div class="list-group">';
            data.recent_analyses.slice(0, 3).forEach(analysis => {
                html += `
                    <a href="/analysis/${analysis.id}" class="list-group-item list-group-item-action">
                        <div class="d-flex w-100 justify-content-between">
                            <h6 class="mb-1">${analysis.query}</h6>
                            <small>${analysis.created_at ? analysis.created_at.slice(0, 10) : ''}</small>
                        </div>
                        <small class="text-muted">–ù–∞–∂–º–∏—Ç–µ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –ø–æ–ª–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞</small>
                    </a>
                `;
            });
            html += '</div>';
            $('#latestAnalyses').html(html);
        } else {
            $('#latestAnalyses').html(`
                <div class="text-center py-3">
                    <i class="bi bi-graph-up display-4 text-muted"></i>
                    <p class="mt-2">–ê–Ω–∞–ª–∏–∑–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç</p>
                    <a href="/analyze" class="btn btn-sm btn-outline-warning">
                        <i class="bi bi-graph-up"></i> –°–æ–∑–¥–∞—Ç—å –∞–Ω–∞–ª–∏–∑
                    </a>
                </div>
            `);
        }
    });
}

// –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
$(document).ready(function() {
    loadLatestNews();
    loadLatestAnalyses();
    
    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ —Å–∏—Å—Ç–µ–º—ã –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
    setInterval(function() {
        $.get('/api/status', function(status) {
            if (status.error) {
                $('#statusIndicator').html(`
                    <i class="bi bi-circle-fill text-danger"></i>
                    <span class="ms-1">–û—à–∏–±–∫–∞: ${status.error}</span>
                `);
            } else {
                $('#statusIndicator').html(`
                    <i class="bi bi-circle-fill text-success"></i>
                    <span class="ms-1">–°–∏—Å—Ç–µ–º–∞ –∞–∫—Ç–∏–≤–Ω–∞ (${status.statistics.total_news} –Ω–æ–≤–æ—Å—Ç–µ–π)</span>
                `);
            }
        });
    }, 30000);
});
</script>
{% endblock %}